<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>NoteCam ‚Äî Fullscreen ‚Äî GPS + District/Mandal/Village</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg1:#041226; --bg2:#071431;
    --accent:#06b6d4; --accent2:#3b82f6;
    --panel: rgba(6,12,20,0.55);
    --muted:#b9c6d2;
    --radius:14px;
    --ui-gap:12px;
  }
  html,body{height:100%;margin:0;font-family:'Poppins',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale}
  body{
    background: linear-gradient(180deg,var(--bg1),var(--bg2));
    color:#eaf4fb;
    display:flex;
    align-items:stretch;
    justify-content:center;
    padding:0;
    height:100vh;
    overflow:hidden;
  }
  .app{
    width:100%;
    height:100vh;
    display:flex;
    flex-direction:column;
    gap:var(--ui-gap);
    padding:10px;
    box-sizing:border-box;
  }
  #camStatus{display:none}
  .viewer{
    position:relative;
    flex:1;
    border-radius:16px;
    overflow:hidden;
    background:#000;
    display:flex;
    align-items:center;
    justify-content:center;
  }
  video{width:100%;height:100%;object-fit:cover;display:block}
  canvas{display:block;width:100%;height:100%}
  .floating-overlay{
    position:absolute;
    left:12px;
    bottom:12px;
    background: rgba(0,0,0,0.45);
    padding:8px 10px;
    border-radius:12px;
    backdrop-filter: blur(5px);
    color:#eaf4fb;
    font-size:13px;
    max-width:70%;
    line-height:1.2;
  }
  .floating-overlay .title{font-weight:600;margin-bottom:4px;font-size:14px}
  .floating-overlay .line{font-size:12px;color:var(--muted)}
  .controls{
    display:flex;
    gap:10px;
    align-items:center;
    justify-content:space-between;
  }
  .controls-left{display:flex;gap:10px;align-items:center}
  .btn{
    appearance:none;border:0;padding:10px 14px;border-radius:14px;background:var(--panel);color:inherit;font-size:15px;cursor:pointer;
    box-shadow:0 4px 18px rgba(0,0,0,0.4);
    display:inline-flex;align-items:center;gap:6px;
    transition: transform 0.12s ease, background 0.2s ease;
  }
  .btn:active{transform:translateY(1px)}
  .btn-primary{
    background:linear-gradient(90deg,var(--accent),var(--accent2));
    color:#021220;font-weight:600;border:none;
  }
  .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.1);color:var(--muted)}
  .permission-gate{
    position:absolute;inset:0;display:flex;align-items:center;justify-content:center;z-index:40;padding:16px;
    background:rgba(0,0,0,0.6);
  }
  .gate-card{
    width:100%;max-width:400px;background:rgba(10,15,25,0.95);
    border-radius:14px;padding:18px;text-align:center;
    border:1px solid rgba(255,255,255,0.03);
    box-shadow:0 14px 42px rgba(0,0,0,0.6);
  }
  .gate-card h2{margin:0 0 8px;font-size:20px}
  .gate-card p{color:var(--muted);margin:6px 0 14px;font-size:14px}
  .modal-backdrop{
    position:fixed;inset:0;background:rgba(0,0,0,0.65);display:flex;align-items:center;justify-content:center;z-index:60;
  }
  .modal{
    width:90%;max-width:480px;background:rgba(10,15,25,0.97);
    border-radius:14px;padding:16px;border:1px solid rgba(255,255,255,0.03);
  }
  .modal h3{margin:0 0 8px;font-weight:600}
  .field{margin-bottom:10px}
  label.small{display:block;font-size:13px;color:var(--muted);margin-bottom:4px}
  input, textarea {
    width:100%;padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.02);color:inherit;font-size:14px;box-sizing:border-box;
  }
  textarea{resize:vertical;min-height:64px}
</style>
</head>
<body>
<div class="app">
  <div id="camStatus">Camera: <span id="camStatText">disabled</span></div>
  <div class="viewer" id="viewer">
    <div class="permission-gate" id="permissionGate">
      <div class="gate-card">
        <h2>Enable camera</h2>
        <p>Tap "Enable Camera" to allow access. You may also allow location when prompted for GPS overlay.</p>
        <div style="display:flex;gap:10px;justify-content:center">
          <button id="enableCameraBtn" class="btn btn-primary">Enable Camera</button>
          <button id="dismissGate" class="btn btn-ghost">Not now</button>
        </div>
      </div>
    </div>
    <video id="video" autoplay playsinline muted></video>
    <canvas id="previewCanvas" style="display:none"></canvas>
    <div class="floating-overlay" id="floatingOverlay" style="display:none">
      <div class="title">Live ‚Ä¢ GPS & Status</div>
      <div class="line" id="floatTime">Time: ‚Äî</div>
      <div class="line" id="floatGps">GPS: acquiring‚Ä¶</div>
      <div class="line" id="floatAccuracy"></div>
    </div>
  </div>
  <div class="controls">
    <div class="controls-left">
      <button id="switchBtn" class="btn">üîÅ Switch</button>
      <button id="captureBtn" class="btn btn-primary">üì∏ Take Photo</button>
      <button id="retakeBtn" class="btn" style="display:none">‚Ü∫ Retake</button>
      <button id="downloadBtn" class="btn" style="display:none">‚¨áÔ∏è Download</button>
    </div>
    <div style="font-size:13px;color:var(--muted)">Location: <span id="locVal">not acquired</span></div>
  </div>
</div>

<!-- Modal -->
<div id="fieldsModal" class="modal-backdrop" style="display:none">
  <div class="modal">
    <h3>Add details</h3>
    <div class="field"><label class="small">District</label><input id="district" type="text" /></div>
    <div class="field"><label class="small">Mandal</label><input id="mandal" type="text" /></div>
    <div class="field"><label class="small">Village</label><input id="village" type="text" /></div>
    <div class="field"><label class="small">Description / Note</label><textarea id="noteText"></textarea></div>
    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:8px">
      <button id="modalCancel" class="btn btn-ghost">Cancel</button>
      <button id="modalSave" class="btn btn-primary">Save & Embed</button>
    </div>
  </div>
</div>

<script>
(async function(){
const video=document.getElementById('video');
const previewCanvas=document.getElementById('previewCanvas');
const captureBtn=document.getElementById('captureBtn');
const retakeBtn=document.getElementById('retakeBtn');
const downloadBtn=document.getElementById('downloadBtn');
const switchBtn=document.getElementById('switchBtn');
const permissionGate=document.getElementById('permissionGate');
const enableCameraBtn=document.getElementById('enableCameraBtn');
const dismissGate=document.getElementById('dismissGate');
const floatingOverlay=document.getElementById('floatingOverlay');
const floatGps=document.getElementById('floatGps');
const floatTime=document.getElementById('floatTime');
const floatAccuracy=document.getElementById('floatAccuracy');
const camStatText=document.getElementById('camStatText');
const locVal=document.getElementById('locVal');
const fieldsModal=document.getElementById('fieldsModal');
const modalSave=document.getElementById('modalSave');
const modalCancel=document.getElementById('modalCancel');
const districtInput=document.getElementById('district');
const mandalInput=document.getElementById('mandal');
const villageInput=document.getElementById('village');
const noteText=document.getElementById('noteText');

let stream=null,currentFacing='environment',lastPosition=null,watchId=null,baseImageData=null;

// Time
function updateTime(){ floatTime.textContent='Time: '+new Date().toLocaleString(); }
setInterval(updateTime,1000);

// Location
function startLocationWatch(){
  if(!navigator.geolocation)return;
  locVal.textContent='acquiring‚Ä¶';
  floatGps.textContent='GPS: acquiring‚Ä¶';
  if(watchId!==null)navigator.geolocation.clearWatch(watchId);
  watchId=navigator.geolocation.watchPosition(pos=>{lastPosition=pos;updateLocText();},
    err=>{locVal.textContent='unavailable';floatGps.textContent='GPS: unavailable';},{enableHighAccuracy:true,maximumAge:8000,timeout:12000});
}
function updateLocText(){
  if(!lastPosition){locVal.textContent='not acquired';floatGps.textContent='GPS: not acquired';floatAccuracy.textContent='';return;}
  const c=lastPosition.coords;
  locVal.textContent=`Lat:${c.latitude.toFixed(6)}, Lon:${c.longitude.toFixed(6)}, ¬±${Math.round(c.accuracy)}m`;
  floatGps.textContent=`Lat:${c.latitude.toFixed(6)} ‚Ä¢ Lon:${c.longitude.toFixed(6)}`;
  floatAccuracy.textContent=`Accuracy: ¬±${Math.round(c.accuracy)}m`;
}

// Start camera
async function startCamera(){
  try{
    if(stream){stream.getTracks().forEach(t=>t.stop());stream=null;}
    camStatText.textContent='starting‚Ä¶';
    const constraints={video:{facingMode:{ideal:currentFacing},width:{ideal:1920},height:{ideal:1080}},audio:false};
    stream=await navigator.mediaDevices.getUserMedia(constraints);
    video.srcObject=stream;await video.play();
    camStatText.textContent='ready';
    floatingOverlay.style.display='block';
  }catch(e){camStatText.textContent='error';alert('Camera error: '+(e.message||e));console.error(e);}
}

// Permission gate
enableCameraBtn.addEventListener('click',async()=>{ await startCamera(); permissionGate.style.display='none'; startLocationWatch(); });
dismissGate.addEventListener('click',()=>{ permissionGate.style.display='none'; });

// Capture
captureBtn.addEventListener('click',()=>{
  if(!stream){alert('Camera not enabled. Tap Enable Camera first.'); return;}
  previewCanvas.width=video.videoWidth||1280;
  previewCanvas.height=video.videoHeight||720;
  const ctx=previewCanvas.getContext('2d');
  ctx.drawImage(video,0,0,previewCanvas.width,previewCanvas.height);
  baseImageData=ctx.getImageData(0,0,previewCanvas.width,previewCanvas.height);
  video.style.display='none';
  previewCanvas.style.display='block';
  captureBtn.style.display='none';
  retakeBtn.style.display='inline-flex';
  downloadBtn.style.display='inline-flex';
  fieldsModal.style.display='flex';
});

// Retake
retakeBtn.addEventListener('click',async()=>{
  previewCanvas.style.display='none';video.style.display='block';
  captureBtn.style.display='inline-flex';retakeBtn.style.display='none';downloadBtn.style.display='none';
  await startCamera();startLocationWatch();
});

// Modal
modalCancel.addEventListener('click',()=>{fieldsModal.style.display='none';});
modalSave.addEventListener('click',()=>{fieldsModal.style.display='none'; updatePreviewOverlay();});

// Overlay
function roundRectPath(ctx,x,y,w,h,r){const radius=Math.min(r,w/2,h/2);ctx.beginPath();ctx.moveTo(x+radius,y);ctx.arcTo(x+w,y,x+w,y+h,radius);ctx.arcTo(x+w,y+h,x,y+h,radius);ctx.arcTo(x,y+h,x,y,radius);ctx.arcTo(x,y,x+w,y,radius);ctx.closePath();}
function updatePreviewOverlay(){
  const c=previewCanvas;if(!c)return;const ctx=c.getContext('2d');
  if(baseImageData)ctx.putImageData(baseImageData,0,0);else ctx.drawImage(video,0,0,c.width,c.height);
  const padding=Math.round(c.width*0.015)+8;
  const fontSize=Math.round(c.width*0.018)+6;
  ctx.font=`${fontSize}px Poppins, sans-serif`;
  ctx.textBaseline='top';
  const lines=[];
  const now=new Date();
  lines.push('Time: '+now.toLocaleString());
  if(lastPosition&&lastPosition.coords){const coords=lastPosition.coords;
    lines.push(`Latitude: ${coords.latitude.toFixed(6)}`);
    lines.push(`Longitude: ${coords.longitude.toFixed(6)}`);
    if(coords.altitude!==null)lines.push(`Altitude: ${coords.altitude.toFixed(1)}m`);
    lines.push(`Accuracy: ¬±${Math.round(coords.accuracy)}m`);
  }else{lines.push('GPS: Not available');}
  if(districtInput.value)lines.push('District: '+districtInput.value);
  if(mandalInput.value)lines.push('Mandal: '+mandalInput.value);
  if(villageInput.value)lines.push('Village: '+villageInput.value);
  if(noteText.value)lines.push('Note: '+noteText.value);
  ctx.fillStyle='rgba(0,0,0,0.45)';
  const boxHeight=lines.length*(fontSize+4)+padding*2;
  ctx.fillRect(padding/2, padding/2, c.width-padding, boxHeight);
  ctx.fillStyle='#fff';
  lines.forEach((line,i)=>{ctx.fillText(line,padding,padding+i*(fontSize+4));});
}

// Download
downloadBtn.addEventListener('click',()=>{
  const link=document.createElement('a');
  link.href=previewCanvas.toDataURL('image/png');
  link.download='notecam.png';link.click();
});

// Switch camera
switchBtn.addEventListener('click',async()=>{currentFacing=currentFacing==='environment'?'user':'environment'; await startCamera(); startLocationWatch();});

})();
</script>
</body>
</html>
